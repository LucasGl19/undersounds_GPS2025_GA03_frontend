<ng-container *ngIf="loading(); else loaded">
  <div class="profile-page">
    <p class="profile-message">Cargando perfilâ€¦</p>
  </div>
</ng-container>

<ng-template #loaded>
  <ng-container *ngIf="user() as profile; else errorState">
    <section>
      <div class="profile-actions">
        <button 
          *ngIf="!isEditing()" 
          (click)="onEdit()" 
          class="btn-edit">
          Editar perfil
        </button>
        <button 
          *ngIf="isEditing()" 
          (click)="onSave()" 
          [disabled]="saving()"
          class="btn-save">
          {{ saving() ? 'Guardando...' : 'Guardar' }}
        </button>
        <button 
          *ngIf="isEditing()" 
          (click)="onCancel()" 
          [disabled]="saving()"
          class="btn-cancel">
          Cancelar
        </button>
        <button (click)="onDeleteAccount()" class="btn-delete-account">
          Borrar cuenta
        </button>
      </div>
      <div class="profile-page">
        <img 
          [src]="profile.avatarUrl || 'assets/images/ui/user-avatar.svg'" 
          [alt]="'Foto de perfil de ' + profile.name" 
          class="profile-photo" 
        />
        <h2>{{ profile.name }}</h2>
        
        <ng-container *ngIf="!isEditing(); else editMode">
          <p *ngIf="profile.username" class="profile-username">{{ '@' + profile.username }}</p>
          <p class="profile-email">{{ profile.email }}</p>
          <p class="profile-role">Rol: {{ profile.role }}</p>
          <p *ngIf="profile.bio" class="profile-bio">{{ profile.bio }}</p>
          <p *ngIf="profile.createdAt" class="profile-date">Miembro desde: {{ profile.createdAt | date:'longDate' }}</p>
        </ng-container>

        <ng-template #editMode>
          <form [formGroup]="profileForm" class="profile-form">
            <!-- SecciÃ³n de imagen de perfil -->
            <div class="form-group avatar-section">
              <label>Foto de perfil</label>
              <div class="avatar-upload-container">
                <div class="avatar-preview">
                  <img 
                    [src]="previewUrl() || profile.avatarUrl || 'assets/images/ui/user-avatar.svg'" 
                    [alt]="'Vista previa de foto de perfil'" 
                    class="preview-image" 
                  />
                </div>
                <div class="avatar-actions">
                  <label for="avatarInput" class="btn-upload">
                    <input 
                      type="file" 
                      id="avatarInput" 
                      accept="image/*"
                      (change)="onFileSelected($event)"
                      style="display: none;"
                    />
                    ðŸ“· Seleccionar imagen
                  </label>
                  <button 
                    type="button" 
                    *ngIf="previewUrl()" 
                    (click)="removeImage()"
                    class="btn-remove-image">
                    âœ• Quitar
                  </button>
                  <small class="image-hint">MÃ¡ximo 2MB (JPG, PNG, GIF)</small>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="username">Nombre de usuario</label>
              <input 
                id="username"
                type="text" 
                formControlName="username"
                class="form-control"
                placeholder="Tu nombre de usuario"
              />
              <span class="error" *ngIf="profileForm.get('username')?.invalid && profileForm.get('username')?.touched">
                El nombre de usuario debe tener al menos 3 caracteres
              </span>
            </div>

            <div class="form-group">
              <label for="bio">BiografÃ­a</label>
              <textarea 
                id="bio"
                formControlName="bio"
                class="form-control"
                rows="4"
                placeholder="CuÃ©ntanos sobre ti..."
              ></textarea>
              <span class="error" *ngIf="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched">
                La biografÃ­a no puede superar los 500 caracteres
              </span>
            </div>

            <p class="profile-email-readonly">Email: {{ profile.email }}</p>
            <p class="profile-role-readonly">Rol: {{ profile.role }}</p>
          </form>
        </ng-template>
      </div>
    </section>
  </ng-container>
</ng-template>

<ng-template #errorState>
  <div class="profile-page">
    <p class="profile-message">{{ error() ?? 'No se pudo cargar el perfil.' }}</p>
  </div>
</ng-template>
